<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Constellation Map Visualizer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      background-color: #0b0c10;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    #controls {
      margin: 20px;
    }
    #plot {
      width: 100%;
      height: 90vh;
    }
    label {
      margin: 0 10px;
    }
  </style>
</head>
<body>
  <h1>Constellation Map Visualizer</h1>

  <div id="controls">
    <input type="file" id="fileInput" accept=".json" />
    <label>Max peaks:
      <input type="range" min="1000" max="20000" step="1000" value="5000" id="pointSlider" />
      <span id="pointCount">5000</span>
    </label>
    <label>
      <input type="checkbox" id="toggleLines" checked /> Show Connections
    </label>
  </div>

  <div id="plot"></div>

  <script>
    let rawData = {};
    let sampledPeaks = [];
    let showLines = true;

    function downsampleData(data, maxPoints = 5000) {
      if (data.length <= maxPoints) return data;
      const step = Math.floor(data.length / maxPoints);
      return data.filter((_, i) => i % step === 0);
    }

    function renderConstellationMap(peaks, pairs) {
      console.log("Rendering with:", peaks.length, "peaks and", pairs.length, "pairs");

      if (peaks.length === 0 && pairs.length === 0) {
        alert("No data to display! Check if JSON keys match.");
        return;
      }

      // Peaks (yellow dots)
      const peakTrace = {
        x: peaks.map(d => d.Time),
        y: peaks.map(d => d.Frequency),
        mode: "markers",
        type: "scattergl",
        marker: {
          color: "yellow",
          size: peaks.map(d => 3 + (d.Magnitude || 0) / 500000),
          opacity: 0.6
        },
        name: "Peaks"
      };

      // Anchors (cyan)
      const anchorTrace = {
        x: pairs.map(p => p.Anchor.Time),
        y: pairs.map(p => p.Anchor.Frequency),
        mode: "markers",
        type: "scattergl",
        marker: { color: "cyan", size: 6, opacity: 0.9 },
        name: "Anchors"
      };

      // Targets (red)
      const targetTrace = {
        x: pairs.map(p => p.Target.Time),
        y: pairs.map(p => p.Target.Frequency),
        mode: "markers",
        type: "scattergl",
        marker: { color: "red", size: 5, opacity: 0.9 },
        name: "Targets"
      };

      // Connection lines
      const connectionTraces = showLines
        ? pairs.map(p => ({
            x: [p.Anchor.Time, p.Target.Time],
            y: [p.Anchor.Frequency, p.Target.Frequency],
            mode: "lines",
            line: { color: "white", width: 1, opacity: 0.3 },
            type: "scattergl",
            hoverinfo: "skip",
            showlegend: false
          }))
        : [];

      Plotly.newPlot(
        "plot",
        [peakTrace, anchorTrace, targetTrace, ...connectionTraces],
        {
          xaxis: { title: "Time (seconds)" },
          yaxis: { title: "Frequency (Hz)" },
          dragmode: "zoom",
          plot_bgcolor: "#0b0c10",
          paper_bgcolor: "#0b0c10",
          font: { color: "#fff" },
          legend: { orientation: "h", y: -0.2 }
        },
        { responsive: true }
      );
    }

    // File upload
    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          rawData = JSON.parse(event.target.result);

          const maxPoints = +document.getElementById("pointSlider").value;
          sampledPeaks = downsampleData(rawData.peaks || [], maxPoints);

          renderConstellationMap(sampledPeaks, rawData.pairs || []);
        } catch (err) {
          alert("Invalid JSON file");
          console.error(err);
        }
      };
      reader.readAsText(file);
    });

    // Slider update
    document.getElementById("pointSlider").addEventListener("input", (e) => {
      const maxPoints = +e.target.value;
      document.getElementById("pointCount").innerText = maxPoints;
      if (rawData.peaks) {
        sampledPeaks = downsampleData(rawData.peaks, maxPoints);
        renderConstellationMap(sampledPeaks, rawData.pairs || []);
      }
    });

    // Toggle lines
    document.getElementById("toggleLines").addEventListener("change", (e) => {
      showLines = e.target.checked;
      renderConstellationMap(sampledPeaks, rawData.pairs || []);
    });
  </script>
</body>
</html>
